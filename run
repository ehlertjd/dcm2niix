#! /bin/bash
#
#
CONTAINER='[scitran/dcm2niix]'
echo -e "$CONTAINER  running..."

# Configure paths
FLYWHEEL_BASE=/flywheel/v0
OUTPUT_DIR=$FLYWHEEL_BASE/output
INPUT_DIR=$FLYWHEEL_BASE/input/dcm2niix
CONFIG_FILE=$FLYWHEEL_BASE/config.json


# If the config file does not exist (local run) then parse the config options
# and values from the manifest
if [[ ! -f $CONFIG_FILE ]]; then
  CONFIG_FILE=$FLYWHEEL_BASE/manifest.json
  # Parse config file to ENV Vars from manifest (note default value is grabbed)
  eval $(jq -r '.config | to_entries[] | "config_\(.key)=\(.value.default)"' $CONFIG_FILE)
else
  # Parse config file to ENV Vars from config
  eval $(jq -r '.config | to_entries[] | "config_\(.key)=\(.value)"' $CONFIG_FILE)
fi


# Get the path to the input_file (should only be a single file in the input dir)
input_file=`find $INPUT_DIR/* -not -path '*/\.*' -type f | head -1`


# The directory that will be sent to dcm2niix
dicom_dir=''


# Depending on the input_file type, unzip, gunzip, or pass
if [[ "$input_file" == *.zip ]] ; then

    echo "$CONTAINER  Unzipping $input_file"
    unzip -q "$input_file" -d $INPUT_DIR

    # Check for unzipped directory in input dir
    dicom_dir=$(find $INPUT_DIR/* -not -path '*/\.*' -type d | head -1)

    # Check for PAR/REC
    if [[ -z $dicom_dir ]]; then
        dicom_dir=$(find $INPUT_DIR/* -not -path '*/\.*' -type f -name "*.par" -o -name "*.PAR" | head -1)
    fi

    # DICOM files
    if [[ -z $dicom_dir ]]; then
        dicom_dir=$(find $INPUT_DIR/* -not -path '*/\.*' -type f | head -1)
    fi

elif [[ "$input_file" == *.gz ]]; then
    cd $INPUT_DIR
    echo "$CONTAINER  Gunzipping $input_file"
    gunzip -q "$input_file"
    dicom_dir=$(basename "$input_file" .gz)

else
    # Assume a directory containing dicoms was mounted in and pass it on
    dicom_dir=$INPUT_DIR
fi

# Decompression of dicom files
if [[ $config_decompress_dicoms == 'true' ]]; then
  RAW_DIR=$dicom_dir/raw
  mkdir $RAW_DIR
  gdcmconv --raw $dicom_dir $RAW_DIR
  if [[ $? == 0 ]]; then
    dicom_dir=$RAW_DIR
  else
    echo "Error decompressing dicoms!"
    exit 1
  fi
fi


# Run the dcm2niix algorithm
dcm2niix $@ -o "$OUTPUT_DIR" -z y "$dicom_dir"


# Get a list of the files in the output directory
outputs=`find $OUTPUT_DIR -not -path '*/\.*' -type f -name "*"`


# If output files exist, happily exit, if not exit 1.
if [ -z "$outputs" ] ; then
    echo "$CONTAINER  No results found in output directory... Exiting(1)!"
    exit 1
else
    chmod -R 777 $OUTPUT_DIR
    echo -e "$CONTAINER  Success! Wrote:\n`ls $OUTPUT_DIR`"
fi

exit 0
